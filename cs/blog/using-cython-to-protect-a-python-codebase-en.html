<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Using Cython to protect a Python codebase - Jan Buchar</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="https://bucharjan.cz/cs/blog/using-cython-to-protect-a-python-codebase-en.html">

        <meta name="author" content="Jan Buchar" />
        <meta name="keywords" content="Python,Cython" />
        <meta name="description" content="Recently, I worked on a Python project that required the whole codebase to be protected using Cython. Although protecting Python sources from reverse engineering seems like a futile task at first, cythonizing all the code leads to a reasonable amount of security (the binary is very difficult to disassemble, but …" />

        <meta property="og:site_name" content="Jan Buchar" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Using Cython to protect a Python codebase"/>
        <meta property="og:url" content="https://bucharjan.cz/cs/blog/using-cython-to-protect-a-python-codebase-en.html"/>
        <meta property="og:description" content="Recently, I worked on a Python project that required the whole codebase to be protected using Cython. Although protecting Python sources from reverse engineering seems like a futile task at first, cythonizing all the code leads to a reasonable amount of security (the binary is very difficult to disassemble, but …"/>
        <meta property="article:published_time" content="2017-07-31" />
            <meta property="article:section" content="Programming" />
            <meta property="article:tag" content="Python" />
            <meta property="article:tag" content="Cython" />
            <meta property="article:author" content="Jan Buchar" />


    <link rel="stylesheet" href="https://bucharjan.cz/cs/../theme/css/style.min.css?b7f6c95d"/>

    <link href="https://bucharjan.cz/cs/../theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://bucharjan.cz/cs/../theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="https://bucharjan.cz/cs/../theme/css/style.css" type="text/css"/>

        <link href="https://bucharjan.cz/cs/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Jan Buchar ATOM Feed"/>



        <link href="https://bucharjan.cz/cs/feeds/programming.atom.xml" type="application/atom+xml" rel="alternate"
              title="Jan Buchar Programming ATOM Feed"/>

</head>
<body>

<div class="page-row page-row-expanded">
<div class="navbar navbar-default" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
		    <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://bucharjan.cz/cs/" class="navbar-brand">
Jan Buchar            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
		<li class="active"><a href="https://bucharjan.cz/cs/blog/">Blog</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
		    <li><a href="https://bucharjan.cz">English</a></li>
		    <li class="active"><a href="https://bucharjan.cz/cs">Čeština</a></li>
		    <!-- OrderedDict([('en', 'https://bucharjan.cz')]) -->
	    <li><a href="https://bucharjan.cz/cs/blog/archives/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archiv</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div id="main" class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://bucharjan.cz/cs/blog/using-cython-to-protect-a-python-codebase-en.html"
                       rel="bookmark"
                       title="Permalink to Using Cython to protect a Python codebase">
                        Using Cython to protect a Python codebase
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
	<span class="label label-default">Datum</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2017-07-31T14:45:00+02:00"> 31/07/17</time>
    </span>





<span class="label label-default">Tagy</span>
	<a href="https://bucharjan.cz/cs/blog/tag/python.html">Python</a>
        /
	<a href="https://bucharjan.cz/cs/blog/tag/cython.html">Cython</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Recently, I worked on a Python project that required the whole codebase to be 
protected using Cython. Although protecting Python sources from reverse 
engineering seems like a futile task at first, cythonizing all the code leads to 
a reasonable amount of security (the binary is very difficult to disassemble, 
but it's still possible to e.g. monkey patch parts of the program). </p>
<p>This security comes with a price though - the primary use case for Cython is
writing compiled extensions that can easily interface with Python code.
Therefore, the support for non-trivial module/package structures is rather
limited and we have to do some extra work to achieve the desired results.</p>
<p>The first obstacle we had to overcome was that it's difficult to compile a whole
Python package (as in "directory containing an <code>__init__.py</code> file") with Cython. 
Imagine the following structure:</p>
<div class="highlight"><pre><span></span>src
├── mypkg
│   ├── bar.py
│   ├── foo.py
│   └── __init__.py
├── mypkg2
│   ├── bar.py
│   ├── foo.py
│   └── __init__.py
└── setup.py
</pre></div>


<p>The recommended way of cythonizing this would be using a <code>setup.py</code> file such as 
this:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span>
<span class="kn">from</span> <span class="nn">setuptools.extension</span> <span class="kn">import</span> <span class="n">Extension</span>

<span class="kn">from</span> <span class="nn">Cython.Build</span> <span class="kn">import</span> <span class="n">cythonize</span>
<span class="kn">from</span> <span class="nn">Cython.Distutils</span> <span class="kn">import</span> <span class="n">build_ext</span>

<span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mypkg&quot;</span><span class="p">,</span>
    <span class="n">ext_modules</span><span class="o">=</span><span class="n">cythonize</span><span class="p">(</span>
        <span class="p">[</span>
           <span class="n">Extension</span><span class="p">(</span><span class="s2">&quot;mypkg.*&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;mypkg/*.py&quot;</span><span class="p">]),</span>
           <span class="n">Extension</span><span class="p">(</span><span class="s2">&quot;mypkg2.*&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;mypkg2/*.py&quot;</span><span class="p">])</span>
        <span class="p">],</span>
        <span class="n">build_dir</span><span class="o">=</span><span class="s2">&quot;build&quot;</span><span class="p">,</span>
        <span class="n">compiler_directives</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">always_allow_keywords</span><span class="o">=</span><span class="bp">True</span>
        <span class="p">)),</span>
    <span class="n">cmdclass</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">build_ext</span><span class="o">=</span><span class="n">build_ext</span>
    <span class="p">),</span>
    <span class="n">packages</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mypkg&quot;</span><span class="p">,</span> <span class="s2">&quot;mypkg2&quot;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>


<p>The <code>setup.py</code> is more or less what you would expect from a project that uses 
Cython. There are two things to be noted though. First, the 
<code>always_allow_keywords</code> directive makes it possible for Flask view functions to 
work correctly by disabling an optimization that only allows keyword arguments 
for functions with a lot of parameters. Second, we do not use the <code>ext_package</code> 
parameter suggested by some guides, which would put the cythonized code into 
another package. By omitting it, the compiled code is kept in the same place.</p>
<p>However, after we build our project with <code>python setup.py build_ext</code>, we notice 
that the resulting package cannot be imported - it is missing an <code>__init__.py</code> 
file. There is <code>__init__.so</code> that can be imported from Python, but that isn't 
enough to make a directory a package in Python's eyes. Not being able to import 
the package is not the only problem - code inside it cannot perform 
package-relative imports (e.g. <code>from .foo import foo</code>) either, which breaks its 
functionality.</p>
<p>To remedy this problem, we can copy the <code>__init__.py</code> file from our source tree 
after the rest of the project is built. A good way to do so is overriding the 
<code>build_ext</code> class in <code>setup.py</code>:</p>
<div class="highlight"><pre><span></span><span class="c1"># ...</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="c1"># ...</span>

<span class="k">class</span> <span class="nc">MyBuildExt</span><span class="p">(</span><span class="n">build_ext</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">build_ext</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">build_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">build_lib</span><span class="p">)</span>
        <span class="n">root_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>

        <span class="n">target_dir</span> <span class="o">=</span> <span class="n">build_dir</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inplace</span> <span class="k">else</span> <span class="n">root_dir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">copy_file</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;mypkg&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;__init__.py&#39;</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copy_file</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;mypkg2&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;__init__.py&#39;</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copy_file</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;mypkg&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;__main__.py&#39;</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copy_file</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;mypkg2&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;__main__.py&#39;</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">,</span> <span class="n">target_dir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">,</span> <span class="n">destination_dir</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">source_dir</span> <span class="o">/</span> <span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">source_dir</span> <span class="o">/</span> <span class="n">path</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">destination_dir</span> <span class="o">/</span> <span class="n">path</span><span class="p">))</span>

<span class="n">setup</span><span class="p">(</span>
<span class="c1"># ...</span>
    <span class="n">cmdclass</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">build_ext</span><span class="o">=</span><span class="n">MyBuildExt</span>
    <span class="p">),</span>
<span class="c1"># ...</span>
<span class="p">)</span>
</pre></div>


<p>We have successfully created Python packages that can be imported from. They 
reside under <code>build/lib.linux-x86_64-3.6</code> or something similar. Sadly, this is 
not enough for the distribution of our package. Ideally, we'd like to have an 
installable package that only contains compiled code. The current standard for 
Python archives is the wheel format (.whl), which aims to replace the .egg 
format. So, let's try to create a wheel with <code>python setup.py bdist_wheel</code>! 
After the command finishes, there should be a <code>dist</code> folder that contains a 
wheel file. Unpacking it yields something like this:</p>
<div class="highlight"><pre><span></span>.
├── mypkg
│   ├── bar.cpython-36m-x86_64-linux-gnu.so
│   ├── bar.py
│   ├── foo.cpython-36m-x86_64-linux-gnu.so
│   ├── foo.py
│   ├── __init__.cpython-36m-x86_64-linux-gnu.so
│   └── __init__.py
├── mypkg-0.0.0.dist-info
│   ├── DESCRIPTION.rst
│   ├── METADATA
│   ├── metadata.json
│   ├── RECORD
│   ├── top_level.txt
│   └── WHEEL
└── mypkg2
    ├── bar.cpython-36m-x86_64-linux-gnu.so
    ├── bar.py
    ├── foo.cpython-36m-x86_64-linux-gnu.so
    ├── foo.py
    ├── __init__.cpython-36m-x86_64-linux-gnu.so
    └── __init__.py
</pre></div>


<p>Apparently, the archive contains not only compiled code, but also the sources. 
There is a way to fix this, however counter-intuitive it might seem. We need to 
remove our packages from the <code>packages</code> argument of the <code>setup</code> call. This way, 
the extensions will still be built and included in the wheel, but the source 
code will not.</p>
<div class="highlight"><pre><span></span><span class="n">setup</span><span class="p">(</span>
    <span class="c1"># ...</span>
    <span class="n">packages</span><span class="o">=</span><span class="p">[]</span>
<span class="p">)</span>
</pre></div>


<p>The content of the built wheel should then look like this:</p>
<div class="highlight"><pre><span></span>dist/
├── mypkg
│   ├── bar.cpython-36m-x86_64-linux-gnu.so
│   ├── foo.cpython-36m-x86_64-linux-gnu.so
│   ├── __init__.cpython-36m-x86_64-linux-gnu.so
│   └── __init__.py
├── mypkg-0.0.0.dist-info
│   ├── DESCRIPTION.rst
│   ├── METADATA
│   ├── metadata.json
│   ├── RECORD
│   ├── top_level.txt
│   └── WHEEL
└── mypkg2
    ├── bar.cpython-36m-x86_64-linux-gnu.so
    ├── foo.cpython-36m-x86_64-linux-gnu.so
    ├── __init__.cpython-36m-x86_64-linux-gnu.so
    └── __init__.py
</pre></div>


<p>The wheel can be installed with <code>pip install dist/*.whl</code>. If we do not need to 
inspect the wheel or distribute it manually, we can just run <code>pip install .</code> in 
the project directory, which builds the wheel and installs it for us.</p>
<p>It is also possible to strip Python source code from .egg archives, but it 
involves overriding the <code>bdist_egg</code> command from <code>setuptools</code>. I won't cover 
that here, but if you're interested, check out the <code>--exclude-source-files</code> 
option and the <code>zap_pyfiles</code> method of aforementioned command class.</p>
<p>By following this guide, you should be able to cythonize a Python codebase with 
non-trivial package/module structure, thus making it difficult for evil hackers 
to reverse engineer it and steal your programming know-how.</p>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section>
    <ul class="list-group list-group-flush">
	<li class="list-group-item"><h4>Sociální sítě</h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/Teyras"><i class="fa fa-github-square fa-lg"></i> Github</a></li>
                <li class="list-group-item"><a href="https://www.linkedin.com/in/jan-buchar"><i class="fa fa-linkedin-square fa-lg"></i> Linkedin</a></li>
                <li class="list-group-item"><a href="https://stackoverflow.com/users/2839862/teyras?tab=profile"><i class="fa fa-stack-overflow fa-lg"></i> Stack overflow</a></li>
              </ul>
            </li>

	    <li class="list-group-item"><h4>Nejnovější články</h4>
                <ul class="list-group" id="recentposts">
                    <li class="list-group-item">
                        <a href="https://bucharjan.cz/cs/blog/using-cython-to-protect-a-python-codebase-en.html">
                            Using Cython to protect a Python codebase
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="https://bucharjan.cz/cs/blog/plasma-custom-modifier-only-shortcuts-en.html">
                            Custom modifier-only shortcuts in Plasma 5.8
                        </a>
                    </li>
                    <li class="list-group-item">
                        <a href="https://bucharjan.cz/cs/blog/web-development-setup-with-uwsgi-en.html">
                            My web development setup with uWSGI
                        </a>
                    </li>
                </ul>
            </li>




    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
</div>
<div class="page-row">
<footer id="footer">
   <div class="container">
      <div class="row">
         <div class="col-xs-10">&copy; 2017 Jan Buchar
		 &middot; Vytvořeno pomocí <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>         </div>
	 <div class="col-xs-2"><p class="pull-right"><a href="#"><i class="fa fa-arrow-up"></i><span class="hidden-xs"> Zpět nahoru</span></a></p></div>
      </div>
   </div>
</footer></div>

<script src="https://bucharjan.cz/cs/../theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://bucharjan.cz/cs/../theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://bucharjan.cz/cs/../theme/js/respond.min.js"></script>

    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-83918237-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

</body>
</html>